<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Civil Center</title>
        <link rel="stylesheet" href="/styles.css"> 
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    </head>
    <body class="site-background" style="padding:0; margin:0; overflow-x:hidden; font-family: 'Inter', sans-serif;">
        
        <!-- Navigation Bar -->
        <div class="nav-bar">
            <div class="indented">
            <h1 style="margin-top:1%; font-size:50px; margin-bottom:5px;">
                <span class="top-bar-span"><strong>Civil<strong><sub>Center</sub></strong></span>
            </h1>
            <div style="width:100vw; padding-bottom:5%; display:flex; justify-content:left; gap:20px;">
                <button class="fancybtn" onclick="window.location.href='/Login.html'">Signout</button>
                <button class="fancybtn" onclick="window.location.href='/Home.html'">Home</button>
                <button class="fancybtn" onclick="window.location.href='/Team.html'">My Profile</button>
            </div>
            </div>
        </div>
        <div class="moving-grid" style="width:100%;padding-top: 20%; height:20%;text-align:center;padding-bottom: 300px;">
            <h1 style="padding-top:5%;">Engage in civil, meaningful dialogue.</h1>
            <p style="padding-top:20px; font-weight:100; margin-left:600px; margin-right:600px;">
            Join a community dedicated to respectful discourse on the issues that matter. Share perspectives, learn from others, and work together towards change.
            </p>
            <div style="display:flex; justify-content:center; gap:30px; margin-top:20px;">
            <button id="create" class="shiny interactive" style="background-color:black; color:silver; border-radius:10px; height:37.25px; width:150px;">Create a Center</button>            
            <button id="join" class="shiny interactive" style="background-color:black; color:silver; border-radius:10px; height:37.25px; width:150px;">Join a Center</button>
            </div>
        </div>

        <div class="dark_content" style=" display:flex; flex-direction:column; align-items:center; padding-bottom: 5%;">
            <h1>Your Centers</h1>
            <div id="centers-list" style="display:flex; flex-wrap:wrap; gap:20px; justify-content:center; margin-top:20px;"></div>
        </div>

        <script type="module">
        import { createClient } from "https://esm.sh/@supabase/supabase-js";

        // Initialize Supabase
        const supabase = createClient(
            "https://vjnzkzoaxtkqhtsaaxzl.supabase.co",
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZqbnprem9heHRrcWh0c2FheHpsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5NTM4NTcsImV4cCI6MjA3NTUyOTg1N30.wG3NTMB1if5AfmqP0Ar8tzznNT8rLuYISlX7qOTwS0o"
        );

        async function getSessionUserId() {
            const { data: { session }, error } = await supabase.auth.getSession();
            if (error || !session) return null;
            return session.user.id;
        }

        // Render centers for the current user
        async function renderUserCenters() {
            const centersList = document.getElementById("centers-list");
            centersList.innerHTML = "<p>Loading centers...</p>";

            const userId = await getSessionUserId();
            if (!userId) {
                centersList.innerHTML = "<p>Please log in to see your centers.</p>";
                return;
            }

            try {
                const { data: userCenters, error } = await supabase
                    .from("center_members")
                    .select(`
                        center_id,
                        centers(name, description, password, members)
                    `)
                    .eq("user_id", userId);

                if (error) throw error;

                centersList.innerHTML = "";
                if (!userCenters || userCenters.length === 0) {
                    centersList.innerHTML = "<p>You have no centers yet.</p>";
                    return;
                }

                // Render each center
                userCenters.forEach(uc => {
                    const center = uc.centers;
                    const card = document.createElement("div");
                    card.className = "shiny interactive";
                    card.style.border = "1px solid #ccc";
                    card.style.borderRadius = "12px";
                    card.style.padding = "15px";
                    card.style.width = "250px";
                    card.style.textAlign = "center";
                    card.style.boxShadow = "0 4px 12px rgba(0,0,0,0.2)";
                    card.style.backgroundColor = "#f9f9f9";
                    card.style.margin = "10px";
                    card.addEventListener("click", () => {
                        localStorage.setItem("selectedCenterId", uc.center_id);
                        localStorage.setItem("selectedCenterName", center.name);
                        localStorage.setItem("selectedCenterDesc", center.description);
                        localStorage.setItem("selectedCenterMembers", center.members);
                        window.location.href = "/Center.html";
                    });

                    card.innerHTML = `
                        <h3>${center.name}</h3>
                        <p>${center.description || "No description"}</p>
                        <p><strong>Password:</strong> ${center.password || "N/A"}</p>
                        <p><strong>Members:</strong> ${center.members || 0}</p>
                        <button class="leave-btn" data-center-id="${uc.center_id}">Leave Center</button>
                    `;

                    centersList.appendChild(card);
                });

                document.querySelectorAll(".leave-btn").forEach(btn => {
                    btn.onclick = async () => {
                        const centerId = btn.dataset.centerId;
                        await leaveCenter(userId, centerId);
                    };
                });

            } catch (err) {
                console.error("Error loading user centers:", err);
                centersList.innerHTML = "<p>Error loading centers.</p>";
            }
        }

        async function leaveCenter(userId, centerId) {
            try {
                const { error } = await supabase
                    .from("center_members")
                    .delete()
                    .eq("user_id", userId)
                    .eq("center_id", centerId);

                if (error) throw error;

                renderUserCenters();
            } catch (err) {
                console.error("Error leaving center:", err);
                alert("Failed to leave center: " + err.message);
            }
        }

        async function setupRealtime() {
            const userId = await getSessionUserId();
            if (!userId) return;

            supabase
                .from(`center_members:user_id=eq.${userId}`)
                .on("*", payload => {
                    console.log("Realtime change:", payload);
                    renderUserCenters();
                })
                .subscribe();
        }

        renderUserCenters();
        setupRealtime();
        </script>

        <div id="create-modal">
            <div class="modal-content">
            <h3>Create a New Center</h3>
            <form id="create-center-form">
                <input type="text" name="name" placeholder="Center Name" required />
                <input type="password" name="password" placeholder="Center Password" required />
                <textarea name="description" placeholder="Description" required></textarea>
                <button type="submit" class="shiny interactive">Create</button>
            </form>
            <span id="close-modal">&times;</span>
            </div>
        </div>
        <!-- Join Center Modal -->
        <div id="join-modal">
        <div class="modal-content">
            <h3>Join a Center</h3>
            <form id="join-center-form">
            <input style="width: 95%;" type="password" name="password" placeholder="Center Password" required />
            <button type="submit" class="shiny interactive">Join</button>
            </form>
            <span id="close-join-modal">&times;</span>
        </div>
        </div>
        <script type="module">
        import { createClient } from "https://esm.sh/@supabase/supabase-js";

        // ---------- Initialize Supabase ----------
        const supabase = createClient(
            "https://vjnzkzoaxtkqhtsaaxzl.supabase.co",
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZqbnprem9heHRrcWh0c2FheHpsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5NTM4NTcsImV4cCI6MjA3NTUyOTg1N30.wG3NTMB1if5AfmqP0Ar8tzznNT8rLuYISlX7qOTwS0o"
        );

        // ---------- Elements ----------
        const createBtn = document.getElementById("create");
        const createModal = document.getElementById("create-modal");
        const closeCreateModal = document.getElementById("close-modal");
        const createForm = document.getElementById("create-center-form");

        const joinBtn = document.getElementById("join");
        const joinModal = document.getElementById("join-modal");
        const closeJoinModal = document.getElementById("close-join-modal");
        const joinForm = document.getElementById("join-center-form");

        // ---------- Create Center Modal ----------
        createBtn.addEventListener("click", () => (createModal.style.display = "flex"));
        closeCreateModal.addEventListener("click", () => (createModal.style.display = "none"));
        window.addEventListener("click", (e) => {
            if (e.target === createModal) createModal.style.display = "none";
        });

        createForm.addEventListener("submit", async (e) => {
            e.preventDefault();

            const { data: { session }, error: sessionError } = await supabase.auth.getSession();

            if (sessionError || !session) {
            alert("You must be logged in to create a center.");
            return;
            }

            const userId = session.user.id;

            const data = {
            userId,
            name: e.target.name.value.trim(),
            password: e.target.password.value.trim(),
            description: e.target.description.value.trim(),
            };

            try {
            const res = await fetch("/api/create-center", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data),
            });

            const json = await res.json();
            if (!res.ok) throw new Error(json.message || "Unknown error");

            alert(json.message);
            createModal.style.display = "none";
            createForm.reset();
            } catch (err) {
            console.error(err);
            alert("Error creating center: " + err.message);
            }
        });

        // ---------- Join Center Modal ----------
        joinBtn.addEventListener("click", () => (joinModal.style.display = "flex"));
        closeJoinModal.addEventListener("click", () => (joinModal.style.display = "none"));
        window.addEventListener("click", (e) => {
            if (e.target === joinModal) joinModal.style.display = "none";
        });

        joinForm.addEventListener("submit", async (e) => {
            e.preventDefault();

            const { data: { session }, error: sessionError } = await supabase.auth.getSession();

            if (sessionError || !session) {
            alert("Unable to fetch user session. Please log in.");
            return;
            }

            const userId = session.user.id;

            const data = {
            userId,
            password: e.target.password.value,
            };

            try {
            const res = await fetch("/api/join-center", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data),
            });

            const json = await res.json();
            if (!res.ok) throw new Error(json.message);

            alert(json.message);
            joinModal.style.display = "none";
            joinForm.reset();
            } catch (err) {
            console.error(err);
            alert("Error joining center: " + err.message);
            }
        });
        </script>
    </body>
</html>
